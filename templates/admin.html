<!DOCTYPE html>
<html>
<head>
    <title>Admin – Login Location Dashboard</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
    body {
        font-family: Arial, sans-serif;
        background: #f3f3f3;
        margin: 0;
        padding: 30px;

        display: flex;
        flex-direction: column;
        align-items: center; /* CENTER EVERYTHING */
    }

    h2 {
        margin-bottom: 20px;
    }

    #map {
        height: 550px;
        width: 80%;               /* reduce from 90% for better balance */
        max-width: 1200px;        /* prevents too wide on large monitors */
        border-radius: 12px;
        box-shadow: 0 0 12px rgba(0,0,0,0.15);
        margin-top: 15px;
    }

    .legend {
        padding: 10px;
        background: white;
        border-radius: 8px;
        line-height: 1.5;

        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1000; /* ensure it stays above map */
        box-shadow: 0 0 8px rgba(0,0,0,0.15);
    }

    .green { color: green; }
    .blue { color: blue; }
    .yellow { color: orange; }
    .red { color: red; }
    </style>    

</head>
<body>

<h2>Login Location Dashboard</h2>

<div class="legend">
    <b>Risk Levels:</b><br/>
    <span class="green">● Low (0–20)</span><br/>
    <span class="blue">● Medium (20–60)</span><br/>
    <span class="yellow">● High (60–100)</span><br/>
    <span class="red">● Severe (100+)</span>
</div>

<div id="map"></div>

<script>
    // initialize map
    const map = L.map('map').setView([20, 0], 2);

    // base layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    // logs passed from Flask
    const logs = {{ logs | tojson}};

    // helper to choose color based on risk score
    function riskColor(score) {
        if (score < 20) return "green";
        if (score < 60) return "blue";
        if (score < 100) return "orange";
        return "red";
    }

    // add markers
    logs.forEach(log => {
        if (!log.lat || !log.lon) return;  // skip entries without geolocation

        const marker = L.circleMarker([log.lat, log.lon], {
            radius: 8,
            color: riskColor(log.risk_score),
            fillColor: riskColor(log.risk_score),
            fillOpacity: 0.9
        }).addTo(map);

        marker.bindPopup(`
            <b>User:</b> ${log.user}<br/>
            <b>IP:</b> ${log.ip}<br/>
            <b>Country:</b> ${log.country || "Unknown"}<br/>
            <b>City:</b> ${log.city || "Unknown"}<br/>
            <b>ISP:</b> ${log.isp || "Unknown"}<br/>
            <b>Risk Score:</b> ${log.risk_score}<br/>
            <b>Reasons:</b><br/>
            ${log.reasons.join("<br/>")}
            <br/><b>Time:</b> ${log.timestamp}
        `);
    });
</script>

</body>
</html>
